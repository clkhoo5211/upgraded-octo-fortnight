name: Use News API in GitHub Actions

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´1ç‚¹æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´9ç‚¹ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      categories:
        description: 'Categories (comma-separated, e.g., tech,finance)'
        required: false
        default: 'tech'

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Fetch news from API
        id: fetch_news
        run: |
          # è®¾ç½®APIåœ°å€
          API_BASE="https://upgraded-octo-fortnight.vercel.app"
          
          # è·å–åˆ†ç±»ï¼ˆä»è¾“å…¥æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
          CATEGORIES="${INPUT_CATEGORIES:-tech}"
          IFS=',' read -ra CAT_ARRAY <<< "$CATEGORIES"
          
          # æ„å»ºåˆ†ç±»æ•°ç»„JSONæ ¼å¼
          CAT_JSON="["
          for i in "${!CAT_ARRAY[@]}"; do
            if [ $i -gt 0 ]; then
              CAT_JSON+=","
            fi
            CAT_JSON+="\"${CAT_ARRAY[$i]}\""
          done
          CAT_JSON+="]"
          
          # è°ƒç”¨APIæœç´¢æ–°é—»
          echo "æ­£åœ¨æœç´¢åˆ†ç±»: $CATEGORIES"
          curl -X POST "${API_BASE}/api/search" \
            -H "Content-Type: application/json" \
            -d "{
              \"categories\": ${CAT_JSON},
              \"date_range\": \"today_and_yesterday\",
              \"max_results\": 20
            }" > news_results.json
          
          # æ£€æŸ¥ç»“æœ
          if [ -f news_results.json ]; then
            COUNT=$(jq -r '.count' news_results.json)
            echo "æ‰¾åˆ° $COUNT æ¡æ–°é—»"
            echo "count=$COUNT" >> $GITHUB_OUTPUT
          else
            echo "è·å–æ–°é—»å¤±è´¥"
            exit 1
          fi
        env:
          INPUT_CATEGORIES: ${{ github.event.inputs.categories }}
      
      - name: Process news data
        run: |
          # æå–æ–°é—»æ ‡é¢˜
          echo "## ğŸ“° ä»Šæ—¥æ–°é—»æ‘˜è¦" > NEWS_SUMMARY.md
          echo "" >> NEWS_SUMMARY.md
          
          jq -r '.news[] | "- **\(.title)**\n  - æ¥æº: \(.source)\n  - é“¾æ¥: \(.url)\n  - æ—¶é—´: \(.published_at)\n"' news_results.json >> NEWS_SUMMARY.md
          
          # æ˜¾ç¤ºæ‘˜è¦
          cat NEWS_SUMMARY.md
      
      - name: Save news to repository
        run: |
          # åˆ›å»ºæ—¥æœŸç›®å½•
          DATE_DIR=$(date +%Y/%m/%d)
          mkdir -p "news_archive/$DATE_DIR"
          
          # ä¿å­˜JSONç»“æœ
          cp news_results.json "news_archive/$DATE_DIR/news.json"
          cp NEWS_SUMMARY.md "news_archive/$DATE_DIR/SUMMARY.md"
          
          # æäº¤åˆ°ä»“åº“
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add news_archive/
          git commit -m "Update news archive for $(date +%Y-%m-%d)" || exit 0
          git push

