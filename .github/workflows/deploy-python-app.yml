name: Deploy Python Application

# 触发条件：推送到main分支或手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # 方案1: 部署到Render (免费PaaS平台)
  deploy-to-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-render]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Render deployment
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "✅ Render deployment triggered"
          else
            echo "⚠️ RENDER_DEPLOY_HOOK_URL secret not configured"
          fi

  # 方案2: 部署到Railway (免费PaaS平台)
  deploy-to-railway:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-railway]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -n "$RAILWAY_TOKEN" ]; then
            railway up
            echo "✅ Railway deployment completed"
          else
            echo "⚠️ RAILWAY_TOKEN secret not configured"
          fi

  # 方案3: 部署到自有服务器 (通过SSH)
  deploy-to-server:
    name: Deploy to VPS/Server
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-server]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /opt/global-news-mcp || exit 1
            git pull origin main
            source venv/bin/activate
            pip install -r requirements.txt
            sudo systemctl restart global-news-mcp
            echo "✅ Server deployment completed"

  # 方案4: 构建并推送Docker镜像
  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[build-docker]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/global-news-mcp:latest
            ${{ secrets.DOCKER_USERNAME }}/global-news-mcp:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Image digest
        run: echo "✅ Docker image pushed successfully"

  # 方案5: 部署到Fly.io (免费PaaS平台)
  deploy-to-flyio:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-flyio]')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          if [ -n "$FLY_API_TOKEN" ]; then
            flyctl deploy --remote-only
            echo "✅ Fly.io deployment completed"
          else
            echo "⚠️ FLY_API_TOKEN secret not configured"
          fi

  # 测试和验证
  test-and-validate:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run health check
        run: |
          python -c "
          from src.news_tools.news_searcher import NewsSearcher
          searcher = NewsSearcher()
          print('✅ NewsSearcher initialized successfully')
          "
      
      - name: Run feature tests
        run: |
          if [ -f "test_features.py" ]; then
            python test_features.py
          else
            echo "⚠️ No test_features.py found"
          fi
